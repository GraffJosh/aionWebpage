<html>
  <head>
    <link rel="icon" type="image/x-icon" href="jpg.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/2.1.2/gpx.min.js" defer></script>
    <style>
        #map { height: 100vh; }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <!-- ... -->
    <script type="module">
        const trackSelector = document.getElementById('trackSelector');
        let currentGPX;

        function loadTrack(url) {
        if (currentGPX) map.removeLayer(currentGPX);

        currentGPX = new L.GPX(url, {
            async: true,
            marker_options: { startIconUrl: null, endIconUrl: null },
        }).on('loaded', (e) => {
            map.fitBounds(e.target.getBounds());
            colorTrackByDate(currentGPX);
        }).addTo(map);
        }

        list_directory('graffjosh', 'aionWebpage', 'gpxFiles')
        .then(files => {
            if (files.length === 0) {
            trackSelector.innerHTML = '<option disabled selected>No GPX files found</option>';
            return;
            }

            files.forEach(file => {
            const opt = document.createElement('option');
            opt.value = file;
            opt.textContent = file.split('/').pop();
            trackSelector.appendChild(opt);
            });

            loadTrack(files[0]);
        });

        trackSelector.addEventListener('change', (e) => {
        loadTrack(e.target.value);
        });
        
        async function list_directory(user, repo, directory) {
            const url = `https://api.github.com/repos/${user}/${repo}/git/trees/master`;
            const list = await fetch(url).then(res => res.json());
            const dir = list.tree.find(node => node.path === directory);
            if (dir) {
                const sublist = await fetch(dir.url).then(res => res.json());
                return sublist.tree
                .filter(node => node.path.endsWith('.gpx'))
                .map(node => `${directory}/${node.path}`);
            } else {
                console.error(`Directory '${directory}' not found in repo.`);
                return [];
            }
        }

     </script>
  </body>
</html>